<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Advanced work with dplyr, ggplot,&nbsp;tidyr</title>
        <link rel="stylesheet" href="../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">János K. Divényi </a></h1>
                <nav><ul>
                    <li><a href="../pages/about-me.html">about&nbsp;me</a></li>
                    <li><a href="../pages/research.html">research</a></li>
                    <li><a href="../pages/teaching.html">teaching</a></li>
                    <li><a href="../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
    <h1 class="entry-title">Advanced work with dplyr, ggplot,&nbsp;tidyr</h1>
    
    <p>Load in required packages and&nbsp;data:</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>nycflights13<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
data<span class="p">(</span>flights<span class="p">)</span>
</pre></div>


<p>Filter out large&nbsp;delays:</p>
<div class="highlight"><pre><span></span>flights <span class="o">&lt;-</span> flights <span class="o">%&gt;%</span> filter<span class="p">(</span>dep_delay <span class="o">&lt;</span> <span class="m">240</span><span class="p">)</span>
</pre></div>


<h2>Function <code>summarise_each</code></h2>
<p>Great to work apply the same summary functions on different&nbsp;variables.</p>
<div class="highlight"><pre><span></span>flights <span class="o">%&gt;%</span> select<span class="p">(</span>dep_delay<span class="p">,</span> arr_delay<span class="p">)</span> <span class="o">%&gt;%</span>
    summarise_each<span class="p">(</span>funs<span class="p">(</span><span class="kp">mean</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>## # A tibble: 1 &lt;U+00D7&gt; 2
##   dep_delay arr_delay
##       &lt;dbl&gt;     &lt;dbl&gt;
## 1  11.21618        NA
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># remove missing values from the calculation</span>
flights <span class="o">%&gt;%</span> select<span class="p">(</span>dep_delay<span class="p">,</span> arr_delay<span class="p">)</span> <span class="o">%&gt;%</span>
    summarise_each<span class="p">(</span>funs<span class="p">(</span><span class="kp">mean</span><span class="p">(</span><span class="m">.</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span>## # A tibble: 1 &lt;U+00D7&gt; 2
##   dep_delay arr_delay
##       &lt;dbl&gt;     &lt;dbl&gt;
## 1  11.21618  5.479534
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># using the helper function matches()</span>
flights <span class="o">%&gt;%</span>
    summarise_each<span class="p">(</span>funs<span class="p">(</span><span class="kp">mean</span><span class="p">(</span><span class="m">.</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">)),</span> matches<span class="p">(</span><span class="s">&quot;delay&quot;</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>## # A tibble: 1 &lt;U+00D7&gt; 2
##   dep_delay arr_delay
##       &lt;dbl&gt;     &lt;dbl&gt;
## 1  11.21618  5.479534
</pre></div>


<h2>Package <code>tidyr</code></h2>
<p>The package <code>tidyr</code> is great for manipulating data from long to wide, or from
wide to long form. <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">Here</a>
you can find a broader introduction, we are going
to use only the <code>gather()</code> and the <code>spread()</code> function.</p>
<div class="highlight"><pre><span></span>flights <span class="o">%&gt;%</span> ggplot<span class="p">(</span>aes<span class="p">(</span>x<span class="o">=</span>dep_delay<span class="p">))</span> <span class="o">+</span> geom_density<span class="p">()</span>
</pre></div>


<p><img alt="plot of chunk density-dep-delay" src="../figure/density-dep-delay-1.png" /></p>
<p>If we would like to plot more variables on the same plot, it is best to first
collect them into one with <code>gather()</code> and then map the type into a new dimension
of the graph (say, color). Here we plot the distribution of the arrival and 
departure delay on the same&nbsp;plot.</p>
<div class="highlight"><pre><span></span>flights <span class="o">%&gt;%</span> gather<span class="p">(</span>delay<span class="p">,</span> value<span class="p">,</span> dep_delay<span class="p">,</span> arr_delay<span class="p">)</span> <span class="o">%&gt;%</span>
    ggplot<span class="p">(</span>aes<span class="p">(</span>x<span class="o">=</span>value<span class="p">,</span> fill<span class="o">=</span>delay<span class="p">))</span> <span class="o">+</span> geom_density<span class="p">(</span>alpha <span class="o">=</span> <span class="m">.3</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>## Warning: Removed 1160 rows containing non-finite values (stat_density).
</pre></div>


<p><img alt="plot of chunk overlaid-density" src="../figure/overlaid-density-1.png" /></p>
<p>The package could be used for creating nice summary tables as well. See an
illustration below, where we first gather the variables we would like to use,
and apply several summary functions after grouping them by their types.
(It may help to understand the command below step-by-step, by looking at the
intermediate&nbsp;results).</p>
<div class="highlight"><pre><span></span>flights <span class="o">%&gt;%</span> 
    gather<span class="p">(</span>measure<span class="p">,</span> value<span class="p">,</span> dep_delay<span class="p">,</span> arr_delay<span class="p">,</span> air_time<span class="p">,</span> distance<span class="p">)</span> <span class="o">%&gt;%</span>
    select<span class="p">(</span>value<span class="p">,</span> measure<span class="p">)</span> <span class="o">%&gt;%</span>
    filter<span class="p">(</span><span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>value<span class="p">))</span> <span class="o">%&gt;%</span>
    group_by<span class="p">(</span>measure<span class="p">)</span> <span class="o">%&gt;%</span>
    summarise_each<span class="p">(</span>funs<span class="p">(</span><span class="kp">mean</span><span class="p">,</span> median<span class="p">,</span> <span class="kp">min</span><span class="p">,</span> <span class="kp">max</span><span class="p">,</span> sd<span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>## # A tibble: 4 &lt;U+00D7&gt; 6
##     measure        mean median   min   max        sd
##       &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1  air_time  150.718955    129    20   695  93.71625
## 2 arr_delay    5.479534     -5   -86   350  39.00446
## 3 dep_delay   11.216184     -2   -43   239  33.82669
## 4  distance 1048.776583    888    80  4983 736.09479
</pre></div>


<h2>For loop and&nbsp;ggplot</h2>
<p>If you would like to create the same plot for different variables, you may want
to use loops instead of typing in the same thing again and again. However, 
looping over variable names is tricky. It is better to loop over the names as
strings, and using the <code>aes_string()</code> function within <code>ggplot()</code> as illustrated
in this&nbsp;example.</p>
<div class="highlight"><pre><span></span><span class="kr">for</span> <span class="p">(</span>var <span class="kr">in</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;dep_delay&quot;</span><span class="p">,</span> <span class="s">&quot;arr_delay&quot;</span><span class="p">))</span> <span class="p">{</span>
    flights <span class="o">%&gt;%</span>
        ggplot<span class="p">(</span>aes_string<span class="p">(</span>x<span class="o">=</span>var<span class="p">))</span> <span class="o">+</span> 
        geom_histogram<span class="p">()</span>
    <span class="c1"># ggsave(paste(var, &quot;_hist.png&quot;))  # you can save them within the loop</span>
<span class="p">}</span>
</pre></div>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="">This webpage is still under construction.</a></li>
                            <li><a href="">Please excuse any incoherence or roughness.</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://github.com/divenyijanos">GitHub</a></li>
                            <li><a href="http://hu.linkedin.com/in/janosdivenyi">LinkedIn</a></li>
                            <li><a href="http://stackoverflow.com/users/3409615/janosdivenyi">Stack Overflow</a></li>
                            <li><a href="https://twitter.com/divenyijanos">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>